name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          pip install pre-commit
      - name: Run pre-commit
        run: pre-commit run --all-files

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test]
          pip install -e .[dev]
      - name: Run ontology integrity checks
        run: python scripts/validate_integrity.py
      - name: Run pre-commit
        run: pre-commit run --all-files
      - name: Run tests
        run: pytest
      - name: Lint
        run: ruff check src tests

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[test] coverage[toml] pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        - name: Test and CLI smoke
          run: |
            set -e
            mkdir -p stubs/pdfminer
            python - <<'PY'
            from pathlib import Path
            from textwrap import dedent

            ROOT = Path("stubs")
            (ROOT / "pdfminer").mkdir(parents=True, exist_ok=True)

            (ROOT / "fastapi.py").write_text(
                dedent(
                    """
                    class HTTPException(Exception):
                        def __init__(self, status_code: int, detail: str):
                            self.status_code = status_code
                            self.detail = detail

                    class APIRouter:
                        def __init__(self):
                            pass

                        def get(self, *a, **k):
                            def deco(fn):
                                return fn

                            return deco

                        def post(self, *a, **k):
                            def deco(fn):
                                return fn

                            return deco


                    def Query(*a, **k):
                        return None
                    """
                ).lstrip()
            )

            (ROOT / "pydantic.py").write_text(
                dedent(
                    """
                    class BaseModel:
                        pass


                    def Field(default, **kwargs):
                        return default
                    """
                ).lstrip()
            )

            (ROOT / "pdfminer" / "high_level.py").write_text(
                dedent(
                    """
                    def extract_text(path):
                        return ""
                    """
                ).lstrip()
            )

            (ROOT / "pdfminer" / "__init__.py").touch()
PY
            export PYTHONPATH="stubs:."
            pytest -q
            python -m src.cli --help
          python scripts/generate_sample_corpus.py
          python examples/distinguish_glj/demo.py
          python -m src.pdf_ingest --help
      - name: Test
        run: pytest --cov=src --cov-report=xml
      - name: Evaluate gold set
        run: sensiblaw eval goldset
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml
